{% extends 'main/base.html' %}
{% load static %}
{% block title %}Mis Sesiones - INACAP Tutorías{% endblock %}

{% block content %}
<div class="header">
    <h1><i class="fa-solid fa-calendar-check"></i> Mis Sesiones de Tutoría</h1>
    <p>Gestiona las solicitudes y sesiones como tutor</p>
</div>

<!-- Sesiones Pendientes -->
<div style="margin-bottom: 30px;">
    <h2 style="border-bottom: 2px solid #e31e24; padding-bottom: 10px; margin-bottom: 15px;">
        <i class="fa-solid fa-clock"></i> Sesiones Pendientes ({{ sesiones_pendientes.count }})
    </h2>
    {% if sesiones_pendientes %}
    <div class="cards">
        {% for sesion in sesiones_pendientes %}
        <div class="card sesion-card pendiente">
            <div class="sesion-header">
                <h3><i class="fa-solid fa-user"></i> {{ sesion.tutorado.get_full_name }}</h3>
                <span class="badge badge-pending">Esperando respuesta</span>
            </div>
            <div class="sesion-body">
                <p><strong>Asignatura:</strong> {{ sesion.asignatura.nombre }}</p>
                <p><strong>Fecha solicitada:</strong> {{ sesion.fecha_programada|date:"d/m/Y H:i" }}</p>
                <p><strong>Modalidad:</strong> {{ sesion.get_modalidad_display }}</p>
                <p><strong>Tema:</strong> {{ sesion.tema_solicitud|truncatewords:15 }}</p>
                <p><strong>Email:</strong> {{ sesion.tutorado.email }}</p>
            </div>
            <div class="sesion-actions">
                <button type="button" class="btn btn-success btn-sm btn-aceptar" data-sesion-id="{{ sesion.id }}">
                    <i class="fa-solid fa-check"></i> Aceptar
                </button>
                <button type="button" class="btn btn-danger btn-sm btn-denegar" data-sesion-id="{{ sesion.id }}">
                    <i class="fa-solid fa-times"></i> Denegar
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="sin-contenido">
        <i class="fa-solid fa-check-circle" style="font-size: 48px; color: #4caf50; margin-bottom: 15px;"></i>
        <p>No tienes sesiones pendientes.</p>
    </div>
    {% endif %}
</div>

<!-- Sesiones Próximas -->
<div style="margin-bottom: 30px;">
    <h2 style="border-bottom: 2px solid #e31e24; padding-bottom: 10px; margin-bottom: 15px;">
        <i class="fa-solid fa-calendar-check"></i> Sesiones Próximas ({{ sesiones_futuras.count }})
    </h2>
    {% if sesiones_futuras %}
    <div class="cards">
        {% for sesion in sesiones_futuras %}
        <div class="card sesion-card aceptada">
            <div class="sesion-header">
                <h3><i class="fa-solid fa-user"></i> {{ sesion.tutorado.get_full_name }}</h3>
                <span class="badge badge-accepted">Confirmada</span>
            </div>
            <div class="sesion-body">
                <p><strong>Asignatura:</strong> {{ sesion.asignatura.nombre }}</p>
                <p><strong>Fecha:</strong> {{ sesion.fecha_programada|date:"d/m/Y H:i" }}</p>
                <p><strong>Modalidad:</strong> {{ sesion.get_modalidad_display }}</p>
                <p><strong>Duración:</strong> {{ sesion.duracion_minutos }} minutos</p>
            </div>
            <div class="sesion-actions">
                <a href="{% url 'chat' sesion.id %}" class="btn btn-primary btn-sm">
                    <i class="fa-solid fa-comments"></i> Chatear
                </a>
                {% if sesion.estado == "Aceptada" %}
                <form method="post" action="{% url 'finalizar_sesion' sesion.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning btn-sm">
                        <i class="fa-solid fa-check-double"></i> Finalizar
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="sin-contenido">
        <i class="fa-solid fa-calendar-times" style="font-size: 48px; color: #999; margin-bottom: 15px;"></i>
        <p>No tienes sesiones confirmadas próximas.</p>
    </div>
    {% endif %}
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
    function getCSRFToken() {
        const token = document.querySelector('meta[name="csrf-token"]');
        return token ? token.getAttribute('content') : getCookie('csrftoken');
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            let cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.querySelectorAll('.btn-aceptar').forEach(button => {
        button.addEventListener('click', () => {
            const sesionId = button.getAttribute('data-sesion-id');
            fetch(`/sesion/${sesionId}/aceptar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Error en la respuesta del servidor');
                return response.json();
            })
            .then(data => {
                alert(data.mensaje || 'Sesión aceptada correctamente');
                location.reload();
            })
            .catch(error => {
                alert('Error al aceptar la sesión');
                console.error(error);
            });
        });
    });

    document.querySelectorAll('.btn-denegar').forEach(button => {
        button.addEventListener('click', () => {
            const sesionId = button.getAttribute('data-sesion-id');
            const razon = prompt("Por favor ingrese el motivo por el cual rechazas esta sesión");
            if (razon === null || razon.trim() === '') {
                alert("Debes ingresar un motivo para denegar la sesión");
                return;
            }
            fetch(`/sesion/${sesionId}/denegar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({razon: razon}),
            })
            .then(response => {
                if (!response.ok) throw new Error('Error en la respuesta del servidor');
                return response.json();
            })
            .then(data => {
                alert(data.mensaje || 'Sesión denegada correctamente');
                location.reload();
            })
            .catch(error => {
                alert('Error al denegar la sesión');
                console.error(error);
            });
        });
    });
});
</script>
{% endblock %}
